#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GITLEAKS_IMAGE="ghcr.io/gitleaks/gitleaks:v8.24.2"

if command -v gitleaks >/dev/null 2>&1; then
  cd "$REPO_ROOT"
  exec gitleaks git --config "$REPO_ROOT/.gitleaks.toml" --redact "$@"
fi

if command -v docker >/dev/null 2>&1; then
  exec docker run --rm \
    -v "$REPO_ROOT:/repo" \
    -w /repo \
    "$GITLEAKS_IMAGE" \
    git --config .gitleaks.toml --redact "$@"
fi

echo "secret-scan failed: install gitleaks or docker." >&2
exit 1
