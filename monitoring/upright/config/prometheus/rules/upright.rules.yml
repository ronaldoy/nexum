# Upright Prometheus Alert Rules
# Generated by: rails generate upright:install

groups:
  - name: upright_recording
    interval: 30s
    rules:
      # Fraction of regions reporting DOWN (0.0 to 1.0)
      - record: upright:probe_down_fraction
        expr: |
          count by (name, type, probe_target) (upright_probe_up == 0)
          /
          count by (name, type, probe_target) (upright_probe_up)

      # Daily uptime percentage (0.0 to 1.0)
      # Uptime = percentage of time in past day when majority of sites reported UP
      - record: upright:probe_uptime_daily
        expr: |
          avg_over_time((
            sum by (name, type, probe_target) (upright_probe_up)
            /
            count by (name, type, probe_target) (upright_probe_up)
            > bool 0.5
          )[1d:])

  - name: upright_alerts
    rules:
      # Mass failure alert - fires when >20% of all probes are failing
      # When this fires, individual probe alerts are suppressed via inhibition rules
      - alert: UprightMassFailure
        annotations:
          summary: "Mass failure - {{ $value | humanizePercentage }} of probes down"
          description: "Many probes failing simultaneously, likely an Upright or network issue"
          upright: "https://app.upright.example.com/?status=fail"
        expr: |
          count(upright:probe_down_fraction > 0.5)
          /
          count(count by (name, type, probe_target) (upright_probe_up))
          > 0.2
        labels:
          severity: critical
          group: upright

      # Pool has fewer active sites than peak in last hour
      - alert: UprightPoolDegraded
        annotations:
          summary: "Upright pool degraded - {{ $value }} site(s) missing"
          description: "Upright pool degraded - {{ $value }} site(s) missing"
          upright: "https://app.upright.example.com/"
        expr: |
          max_over_time(count(count by (site_code) (upright_probe_up))[1h:1m])
          -
          count(count by (site_code) (upright_probe_up))
          > 0
        for: 5m
        labels:
          severity: critical
          group: upright

      # No HTTP metrics at all - probes completely stopped
      - alert: UprightHTTPProbesMissing
        annotations:
          summary: "HTTP probes missing - no metrics received"
          description: "No HTTP probe metrics are being reported. Upright may be down or probes are stuck."
          upright: "https://app.upright.example.com/?probe_type=http"
        expr: absent(upright_probe_up{type="http"})
        for: 5m
        labels:
          severity: critical
          group: upright

      # No SMTP metrics at all - probes completely stopped
      - alert: UprightSMTPProbesMissing
        annotations:
          summary: "SMTP probes missing - no metrics received"
          description: "No SMTP probe metrics are being reported. Upright may be down or probes are stuck."
          upright: "https://app.upright.example.com/?probe_type=smtp"
        expr: absent(upright_probe_up{type="smtp"})
        for: 5m
        labels:
          severity: critical
          group: upright

      # No Playwright metrics at all - probes completely stopped
      - alert: UprightPlaywrightProbesMissing
        annotations:
          summary: "Playwright probes missing - no metrics received"
          description: "No Playwright probe metrics are being reported. Browser probes may be stuck or Upright is down."
          upright: "https://app.upright.example.com/?probe_type=playwright"
        expr: absent(upright_probe_up{type="playwright"})
        for: 30m
        labels:
          severity: critical
          group: upright

      # Site stopped reporting HTTP probes (was reporting in last hour, not now)
      - alert: UprightHTTPSiteMissing
        annotations:
          summary: "HTTP probes missing from {{ $labels.site_city }}"
          description: "{{ $labels.site_city }} ({{ $labels.site_code }}) stopped reporting HTTP probe metrics."
          upright: "https://{{ $labels.site_code }}.upright.example.com/?probe_type=http"
        expr: |
          count by (site_code, site_city) (max_over_time(upright_probe_up{type="http"}[1h]))
          unless
          count by (site_code, site_city) (upright_probe_up{type="http"})
        for: 5m
        labels:
          severity: warning
          group: upright

      # Site stopped reporting SMTP probes (was reporting in last hour, not now)
      - alert: UprightSMTPSiteMissing
        annotations:
          summary: "SMTP probes missing from {{ $labels.site_city }}"
          description: "{{ $labels.site_city }} ({{ $labels.site_code }}) stopped reporting SMTP probe metrics."
          upright: "https://{{ $labels.site_code }}.upright.example.com/?probe_type=smtp"
        expr: |
          count by (site_code, site_city) (max_over_time(upright_probe_up{type="smtp"}[1h]))
          unless
          count by (site_code, site_city) (upright_probe_up{type="smtp"})
        for: 5m
        labels:
          severity: warning
          group: upright

      # Site stopped reporting Playwright probes (was reporting in last hour, not now)
      - alert: UprightPlaywrightSiteMissing
        annotations:
          summary: "Playwright probes missing from {{ $labels.site_city }}"
          description: "{{ $labels.site_city }} ({{ $labels.site_code }}) stopped reporting Playwright probe metrics. Probes may be stuck."
          upright: "https://{{ $labels.site_code }}.upright.example.com/?probe_type=playwright"
        expr: |
          count by (site_code, site_city) (max_over_time(upright_probe_up{type="playwright"}[1h]))
          unless
          count by (site_code, site_city) (upright_probe_up{type="playwright"})
        for: 30m
        labels:
          severity: warning
          group: upright

  # HTTP probe alerts (simple endpoint monitoring)
  - name: upright_http_alerts
    rules:
      - alert: UprightHTTPProbeDown
        annotations:
          summary: "HTTP: {{ $labels.name }} is DOWN"
          description: "{{ $value | humanizePercentage }} of regions report failure on {{ $labels.probe_target }}"
          upright: "https://app.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        expr: upright:probe_down_fraction{type="http"} > 0.5
        labels:
          severity: page
          group: upright

      - alert: UprightHTTPProbeDegraded
        annotations:
          summary: "HTTP: {{ $labels.name }} degraded - {{ $value | humanizePercentage }} of regions down"
          description: "{{ $value | humanizePercentage }} of regions report failure on {{ $labels.probe_target }}"
          upright: "https://app.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        expr: upright:probe_down_fraction{type="http"} > 0.25 and upright:probe_down_fraction{type="http"} <= 0.5
        for: 5m
        labels:
          severity: warning
          group: upright

      - alert: UprightHTTPRegionalFailure
        annotations:
          summary: "HTTP: {{ $labels.name }} failing from {{ $labels.site_city }}"
          description: "HTTP: {{ $labels.probe_target }} failing from {{ $labels.site_city }}"
          upright: "https://{{ $labels.site_code }}.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        # Only fire when exactly 1 site is down (isolated regional issue)
        expr: |
          upright_probe_up{type="http"} == 0
          and on (name, type, probe_target)
          count by (name, type, probe_target) (upright_probe_up == 0) == 1
        for: 2m
        labels:
          severity: warning
          group: upright

  # SMTP probe alerts (mail server monitoring)
  - name: upright_smtp_alerts
    rules:
      - alert: UprightSMTPProbeDown
        annotations:
          summary: "SMTP: {{ $labels.name }} is DOWN"
          description: "{{ $value | humanizePercentage }} of regions report failure on {{ $labels.probe_target }}"
          upright: "https://app.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        expr: upright:probe_down_fraction{type="smtp"} > 0.5
        labels:
          severity: page
          group: upright

      - alert: UprightSMTPProbeDegraded
        annotations:
          summary: "SMTP: {{ $labels.name }} degraded - {{ $value | humanizePercentage }} of regions down"
          description: "{{ $value | humanizePercentage }} of regions report failure on {{ $labels.probe_target }}"
          upright: "https://app.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        expr: upright:probe_down_fraction{type="smtp"} > 0.25 and upright:probe_down_fraction{type="smtp"} <= 0.5
        for: 5m
        labels:
          severity: warning
          group: upright

      - alert: UprightSMTPRegionalFailure
        annotations:
          summary: "SMTP: {{ $labels.name }} failing from {{ $labels.site_city }}"
          description: "SMTP: {{ $labels.probe_target }} failing from {{ $labels.site_city }}"
          upright: "https://{{ $labels.site_code }}.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        # Only fire when exactly 1 site is down (isolated regional issue)
        expr: |
          upright_probe_up{type="smtp"} == 0
          and on (name, type, probe_target)
          count by (name, type, probe_target) (upright_probe_up == 0) == 1
        for: 2m
        labels:
          severity: warning
          group: upright

  # Playwright probe alerts (browser-based login flows)
  - name: upright_playwright_alerts
    rules:
      - alert: UprightPlaywrightProbeFailed
        annotations:
          summary: "Browser: {{ $labels.name }} probe FAILED"
          description: "{{ $value | humanizePercentage }} of regions report failure for browser-based probe on {{ $labels.name }}"
          upright: "https://app.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        expr: upright:probe_down_fraction{type="playwright"} > 0.5
        labels:
          severity: page
          group: upright

      - alert: UprightPlaywrightProbeDegraded
        annotations:
          summary: "Browser: {{ $labels.name }} degraded - {{ $value | humanizePercentage }} of regions down"
          description: "Not all regions report success for browser-based probe {{ $labels.name }}"
          upright: "https://app.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        expr: upright:probe_down_fraction{type="playwright"} > 0.25 and upright:probe_down_fraction{type="playwright"} <= 0.5
        for: 20m
        labels:
          severity: warning
          group: upright

      - alert: UprightPlaywrightRegionalFailure
        annotations:
          summary: "Browser: {{ $labels.name }} failing from {{ $labels.site_city }}"
          description: "Browser: {{ $labels.name }} failing from {{ $labels.site_city }}"
          upright: "https://{{ $labels.site_code }}.upright.example.com/?probe_type={{ $labels.type }}&status=fail&probe_name={{ $labels.name | urlquery }}"
        # Only fire when exactly 1 site is down (isolated regional issue)
        expr: |
          upright_probe_up{type="playwright"} == 0
          and on (name, type, probe_target)
          count by (name, type, probe_target) (upright_probe_up == 0) == 1
        for: 20m
        labels:
          severity: warning
          group: upright
